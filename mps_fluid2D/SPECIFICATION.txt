================================================================================
  MPS法 2次元非圧縮性流体シミュレーション 仕様書
================================================================================

1. 概要
--------------------------------------------------------------------------------

  本プログラムは Moving Particle Semi-implicit (MPS) 法に基づく2次元非圧縮性
  流体シミュレータである。ダムブレイク問題（水柱崩壊）を対象とし、流体の自由
  表面流れを粒子法で計算する。

  手法の基礎: Koshizuka & Oka (1996)
  "Moving-Particle Semi-implicit Method for Fragmentation of Incompressible Fluid"


2. 物理モデル
--------------------------------------------------------------------------------

  2.1 支配方程式

    非圧縮性ナビエ・ストークス方程式:
      Du/Dt = -(1/rho) * grad(P) + nu * laplacian(u) + g

    連続の式 (非圧縮条件):
      div(u) = 0

  2.2 MPS離散化

    粒子間相互作用の重み関数 (カーネル):
      w(r, re) = re/r - 1    (0 < r < re)
      w(r, re) = 0            (r >= re)
      ※ r < R_MIN (= 0.01 * l0) の場合は R_MIN でクランプ

    粒子数密度:
      n_i = Sum_j w(|r_j - r_i|, re)

    ラプラシアンモデル (粘性項):
      <laplacian(u)>_i = (2D / (n0 * lambda)) * Sum_j (u_j - u_i) * w_ij

    勾配モデル (圧力勾配):
      <grad(P)>_i = (D / n0) * Sum_j [(P_j - P_min) / |r_j - r_i|^2]
                    * (r_j - r_i) * w_ij
      ※ P_min: 近傍粒子の最小圧力 (数値安定性のため)


3. 計算パラメータ
--------------------------------------------------------------------------------

  3.1 粒子パラメータ

    パラメータ名           記号      値         単位
    -------------------------------------------------------
    初期粒子間距離         l0        0.025      m
    影響半径               re        2.1 * l0   m
    最大粒子数             -         10000      個
    最大近傍粒子数         -         256        個/粒子
    壁粒子層数             -         3          層

  3.2 物性値

    パラメータ名           記号      値         単位
    -------------------------------------------------------
    流体密度               rho       1000.0     kg/m^3
    動粘性係数             nu        1.0e-6     m^2/s
    重力加速度 (x成分)     g_x       0.0        m/s^2
    重力加速度 (y成分)     g_y       -9.81      m/s^2

  3.3 時間パラメータ

    パラメータ名           記号      値         単位
    -------------------------------------------------------
    時間刻み               dt        5.0e-4     s
    終了時刻               T_end     2.0        s
    出力間隔               -         100        ステップ

  3.4 圧力計算パラメータ

    パラメータ名                     値
    -------------------------------------------------------
    CG法 最大反復数                  10000
    CG法 収束判定閾値                1.0e-8
    圧力の緩和係数                   0.2

  3.5 自由表面判定

    粒子数密度比 n_i / n0 < 0.97 の粒子を自由表面と判定し、圧力 = 0 とする。


4. 計算領域とダムブレイク初期条件
--------------------------------------------------------------------------------

  4.1 計算領域

    X方向: 0.0 ~ 1.0 m
    Y方向: 0.0 ~ 0.6 m (上面は開放境界)
    壁: 底面・左壁・右壁に3層の壁粒子を配置

  4.2 初期水柱

    幅:   0.25 m (X方向: 0 ~ 0.25 m)
    高さ: 0.50 m (Y方向: 0 ~ 0.50 m)

  4.3 初期粒子数 (l0 = 0.025 m の場合)

    流体粒子: 171 個
    壁粒子:   273 個
    合計:     444 個


5. 時間積分アルゴリズム (Semi-implicit法)
--------------------------------------------------------------------------------

  各タイムステップは陽的ステップと陰的ステップの2段階で構成される。

  5.1 陽的ステップ (仮速度・仮位置の計算)

    (1) 加速度の初期化: acc = (g_x, g_y)
    (2) 粘性項の加算:   acc += nu * <laplacian(u)>
    (3) 仮速度の更新:   u* = u^n + dt * acc
    (4) CFL速度制限:    |u*| > v_max の場合クランプ (後述 6.1)
    (5) 仮位置の更新:   r* = r^n + dt * u*
    (6) 壁粒子の固定:   壁粒子の速度・加速度をゼロに設定
    (7) 壁面位置クランプ: 貫通粒子の押し戻し (後述 6.3)

  5.2 陰的ステップ (圧力補正)

    (1)  近傍探索の更新 (仮位置にて)
    (2)  壁面反発力の適用 (後述 6.2)
    (3)  粒子間衝突処理 (後述 6.4)
    (4)  粒子数密度 n* の計算
    (5)  自由表面判定
    (6)  圧力ポアソン方程式の求解 (CG法)
    (7)  負圧のクランプ (P < 0 → P = 0)
    (8)  圧力勾配による速度・位置の修正:
           u^{n+1} = u* + dt * acc_pressure
           r^{n+1} = r* + dt * (dt * acc_pressure)
    (9)  壁粒子の再固定
    (10) 壁面位置クランプ (後述 6.3)
    (11) 領域外粒子の処理 (ゴースト化)


6. 壁貫通防止処理
--------------------------------------------------------------------------------

  MPS法において高速移動する流体粒子が壁粒子を突き抜ける問題を防止するため、
  以下の3つの手法を組み合わせて適用する。

  6.1 CFL速度制限 (clamp_velocity)

    目的:
      1タイムステップで粒子が粒子間距離 l0 以上移動することを防止する。

    処理内容:
      最大許容速度: v_max = CFL * l0 / dt
      流体粒子の速度 |v| が v_max を超える場合、速度ベクトルの方向を保ったまま
      大きさを v_max にクランプする:
        v = v_max * (v / |v|)

    パラメータ:
      CFL_NUMBER = 0.2

    適用タイミング:
      陽的ステップの速度更新後、位置更新前 (ステップ 5.1-(4))

    根拠:
      CFL条件 (Courant-Friedrichs-Lewy) に基づく。CFL = 0.2 とすることで
      1ステップの移動量を l0 の 20% 以下に制限し、粒子が近傍構造を飛び越える
      ことを防ぐ。

  6.2 壁面反発力 (apply_wall_repulsion)

    目的:
      壁粒子に近づきすぎた流体粒子を壁から遠ざける連続的な反発力を与える。

    処理内容:
      流体粒子 i と壁粒子 j の距離 r が l0 未満の場合:
        overlap = 1.0 - r / l0
        force_mag = WALL_REPULSION_COEFF * overlap^2
        v_i += dt * force_mag * (r_i - r_j) / r

      ※ 壁粒子から流体粒子への一方向のみ適用
      ※ overlap の2乗に比例するため、壁に近いほど強い反発力が働く

    パラメータ:
      WALL_REPULSION_COEFF = 196.2 (= 0.5 * |g| / l0)

    適用タイミング:
      陰的ステップの近傍探索後、粒子間衝突処理の直前 (ステップ 5.2-(2))

  6.3 壁面位置クランプ (clamp_to_walls)

    目的:
      壁ジオメトリを直接使用して、貫通した粒子を押し戻す最終安全策。

    処理内容:
      流体粒子の位置を以下の範囲にクランプする:
        左壁:  x >= DOMAIN_X_MIN + l0/2   (= 0.0125 m)
        右壁:  x <= DOMAIN_X_MAX - l0/2   (= 0.9875 m)
        底面:  y >= DOMAIN_Y_MIN + l0/2   (= 0.0125 m)
        上面:  クランプなし (開放境界)

      壁を貫通した粒子に対して:
        (a) 位置を境界値にクランプ
        (b) 壁の法線方向の速度成分を反転し、反発係数で減衰させる
            v_normal *= -WALL_RESTITUTION

    パラメータ:
      WALL_RESTITUTION = 0.2 (非弾性反射)

    適用タイミング:
      陽的ステップの位置更新後 (ステップ 5.1-(7))
      陰的ステップの圧力補正後 (ステップ 5.2-(10))
      ※ 両方のステップで適用し、あらゆる貫通を確実に防止する

  6.4 粒子間衝突処理 (handle_collision) ※既存機能

    目的:
      過度に接近した粒子対の重なりを解消する。

    処理内容:
      2粒子の距離が衝突距離 (l0 * 0.5) 以下かつ接近中の場合、
      法線方向の相対速度を反転・減衰させる。
        反発係数: 0.2
        速度補正: impulse = -(1 + e) * v_normal * 0.5


7. 境界条件
--------------------------------------------------------------------------------

  7.1 壁粒子

    壁粒子 (WALL_PARTICLE) は速度・加速度を常にゼロに固定する。
    陽的ステップ後と陰的ステップ後の2回適用する。

  7.2 自由表面

    自由表面粒子の圧力をゼロに設定する。
    圧力ポアソン方程式においてディリクレ境界条件として機能する。

  7.3 領域外粒子処理

    以下の条件を満たす流体粒子をゴースト粒子 (GHOST_PARTICLE) に変換する:
      - 計算領域から margin = l0 * (WALL_LAYERS + 1) 以上離れた位置にある
      - 座標が NaN を含む
    ゴースト粒子は以降の計算から除外される。


8. 圧力ソルバ
--------------------------------------------------------------------------------

  8.1 圧力ポアソン方程式

    <laplacian(P)>_i = -(rho / dt^2) * (n*_i - n0) / n0

    右辺に緩和係数 (RELAXATION_COEFF = 0.2) を乗じて数値安定性を確保する。

  8.2 解法

    共役勾配法 (CG法) により対称正定値の連立方程式を解く。
      最大反復数: 10000
      収束判定:   ||r|| < 1.0e-8

  8.3 負圧クランプ

    物理的に意味のない負の圧力値をゼロにクランプする。


9. 粒子種別
--------------------------------------------------------------------------------

  種別              値    説明
  -----------------------------------------------------------
  FLUID_PARTICLE    0     流体粒子 (計算対象)
  WALL_PARTICLE     1     壁粒子 (固定、圧力計算の境界)
  GHOST_PARTICLE    2     ゴースト粒子 (計算から除外)


10. 出力形式
--------------------------------------------------------------------------------

  10.1 CSV形式

    ファイル名: output/output_XXXXXX.csv (6桁ゼロ埋めステップ番号)
    ヘッダ行:   x,y,vx,vy,pressure,type

    列          内容                    単位
    -----------------------------------------------
    x           位置 X座標              m
    y           位置 Y座標              m
    vx          速度 X成分              m/s
    vy          速度 Y成分              m/s
    pressure    圧力                    Pa
    type        粒子種別 (0/1)          -

    ※ ゴースト粒子 (type=2) は出力しない

  10.2 VTK形式

    ファイル名: output/output_XXXXXX.vtk
    形式:       VTK Legacy ASCII (Version 3.0)
    データセット: UNSTRUCTURED_GRID (VTK_VERTEX)

    フィールド:
      - pressure (scalar, double)
      - type (scalar, int)
      - velocity (vector, double)

    ※ ゴースト粒子は出力しない
    ※ ParaView で読み込み可能


11. ファイル構成
--------------------------------------------------------------------------------

  mps_fluid/
  |-- Makefile                  ビルド設定
  |-- include/
  |   |-- config.h              計算パラメータ定義
  |   |-- particle.h            粒子・粒子系の構造体定義
  |   |-- simulation.h          シミュレーションループ
  |   |-- operators.h           MPS演算子 (粘性・圧力勾配・粒子数密度)
  |   |-- pressure_solver.h     圧力ポアソン方程式ソルバ
  |   |-- boundary.h            境界条件・衝突処理・壁貫通防止
  |   |-- neighbor_search.h     近傍探索
  |   |-- kernel.h              カーネル重み関数
  |   |-- io.h                  入出力
  |-- src/
  |   |-- main.c                メインプログラム・初期条件設定
  |   |-- simulation.c          時間積分ループ
  |   |-- operators.c           MPS演算子の実装
  |   |-- pressure_solver.c     CG法による圧力ソルバ
  |   |-- boundary.c            境界条件・衝突・壁貫通防止の実装
  |   |-- neighbor_search.c     全探索による近傍探索
  |   |-- kernel.c              カーネル関数の実装
  |   |-- particle.c            粒子系の生成・管理
  |   |-- io.c                  CSV/VTK出力
  |-- vis/
  |   |-- visualize.py          Python可視化スクリプト
  |-- output/                   シミュレーション出力ディレクトリ


12. 参考文献
--------------------------------------------------------------------------------

  [1] S. Koshizuka and Y. Oka, "Moving-Particle Semi-implicit Method for
      Fragmentation of Incompressible Fluid," Nuclear Science and Engineering,
      Vol. 123, pp. 421-434, 1996.
